version: build.{build}.branch.{branch}

image:
  - Visual Studio 2017
  - Ubuntu
  - macos-mojave

environment:
  MINICONDA_LINUX_URL: "https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh"
  MINICONDA_OSX_URL: "https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh"

init:
  - ps: >-
      if ($env:APPVEYOR_REPO_TAG -eq "true")
      {
        Update-AppveyorBuild -Version "$($env:APPVEYOR_REPO_TAG_NAME.TrimStart("v"))"
      }

install:
  - cmd: call "C:\Miniconda3-x64\Scripts\activate.bat"
  - cmd: call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars64.bat"
  - sh: >-
      if [ "${APPVEYOR_BUILD_WORKER_IMAGE}" = "Ubuntu" ]; then
        wget "${MINICONDA_LINUX_URL}" -O miniconda_install.sh;
      else
        curl "${MINICONDA_OSX_URL}" -o miniconda_install.sh;
        sudo mkdir /opt;
        sudo ln -s /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk /opt/MacOSX10.9.sdk;
      fi
  - sh: >-
      chmod +x miniconda_install.sh;
      ./miniconda_install.sh -b -p "${HOME}/miniconda3";
      source "${HOME}/miniconda3/etc/profile.d/conda.sh";
  - conda config --set always_yes yes --set changeps1 no
  - conda update -q --all
  - conda install conda-build

build_script:
  - conda build recipe --no-test --output-folder dist

test_script:
  - ps: conda build --test (Resolve-Path 'dist\**\*.tar.bz2').Path

artifacts:
  path: 'dist\**\*.tar.bz2'
